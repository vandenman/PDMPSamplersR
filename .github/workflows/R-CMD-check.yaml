on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

name: R-CMD-check

permissions: read-all

jobs:
  R-CMD-check:
    runs-on: ${{ matrix.config.os }}

    name: ${{ matrix.config.os }} (${{ matrix.config.julia && 'with Julia' || 'no Julia' }})

    strategy:
      fail-fast: false
      matrix:
        config:
          - {os: ubuntu-latest,  julia: true}
          - {os: ubuntu-latest,  julia: false}
          - {os: macOS-latest,   julia: true}
          - {os: windows-latest, julia: true}

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes
      QUARTO_LOG_LEVEL: TRACE

    steps:
      - uses: actions/checkout@v6

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          # local::. is needed for quarto vignettes on Windows
          # see https://github.com/quarto-dev/quarto-r/issues/217
          extra-packages: any::rcmdcheck, local::.
          needs: check

      - name: Install Julia
        if: matrix.config.julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '1'

      - name: Cache Julia packages
        if: matrix.config.julia
        uses: julia-actions/cache@v2

      - name: Configure RCall Julia preferences
        if: matrix.config.julia
        shell: Rscript {0}
        run: |
          rhome <- R.home()
          # "julia version 1.12.5" -> "1.12"
          julia_ver_out <- system2("julia", "--version", stdout = TRUE)
          julia_ver_full <- strsplit(trimws(julia_ver_out), "\\s+")[[1]][3]
          parts <- strsplit(julia_ver_full, "\\.")[[1]]
          julia_ver <- paste(parts[1:2], collapse = ".")
          julia_depot <- Sys.getenv("JULIA_DEPOT_PATH", unset = "")
          if (nzchar(julia_depot)) {
            # JULIA_DEPOT_PATH may be colon/semicolon-separated; take first entry
            julia_depot <- strsplit(julia_depot, .Platform$path.sep)[[1]][1]
          } else {
            julia_depot <- file.path(path.expand("~"), ".julia")
          }
          env_dir <- file.path(julia_depot, "environments", paste0("v", julia_ver))
          dir.create(env_dir, recursive = TRUE, showWarnings = FALSE)

          sysname <- Sys.info()[["sysname"]]
          libr <- if (sysname == "Windows") {
            # try x64 first, fall back to plain bin/
            p64 <- file.path(rhome, "bin", "x64", "R.dll")
            if (file.exists(p64)) p64 else file.path(rhome, "bin", "R.dll")
          } else if (sysname == "Darwin") {
            file.path(rhome, "lib", "libR.dylib")
          } else {
            file.path(rhome, "lib", "libR.so")
          }

          # Normalise to forward slashes (important on Windows)
          rhome <- gsub("\\\\", "/", rhome)
          libr  <- gsub("\\\\", "/", libr)

          prefs_path <- file.path(env_dir, "LocalPreferences.toml")
          prefs <- sprintf('[RCall]\nRhome = "%s"\nlibR = "%s"\n', rhome, libr)
          writeLines(prefs, prefs_path)
          message("Wrote ", prefs_path, ":\n", prefs)

          # Export R_HOME and library path so Julia/RCall can find R in all subsequent steps
          gh_env <- Sys.getenv("GITHUB_ENV", unset = "")
          if (nzchar(gh_env)) {
            env_lines <- sprintf("R_HOME=%s", rhome)
            if (sysname == "Linux") {
              lib_dir <- file.path(rhome, "lib")
              old_ld <- Sys.getenv("LD_LIBRARY_PATH", unset = "")
              new_ld <- if (nzchar(old_ld)) paste(lib_dir, old_ld, sep = ":") else lib_dir
              env_lines <- c(env_lines, sprintf("LD_LIBRARY_PATH=%s", new_ld))
            } else if (sysname == "Darwin") {
              lib_dir <- file.path(rhome, "lib")
              old_dl <- Sys.getenv("DYLD_FALLBACK_LIBRARY_PATH", unset = "")
              new_dl <- if (nzchar(old_dl)) paste(lib_dir, old_dl, sep = ":") else lib_dir
              env_lines <- c(env_lines, sprintf("DYLD_FALLBACK_LIBRARY_PATH=%s", new_dl))
            }
            cat(paste(env_lines, collapse = "\n"), "\n", file = gh_env, append = TRUE)
            message("Exported to GITHUB_ENV:\n", paste(env_lines, collapse = "\n"))
          }

      - name: Install JuliaCall dependencies
        if: matrix.config.julia
        run: julia -e 'using Pkg; Pkg.add("Suppressor"); Pkg.add("RCall")'
        shell: bash

      - name: Test Julia-R integration
        if: matrix.config.julia
        run: |
          echo "=== R_HOME=$R_HOME ==="
          echo "=== LD_LIBRARY_PATH=$LD_LIBRARY_PATH ==="

          echo "=== Step 1: Julia standalone ==="
          julia -e 'println("Julia OK: ", VERSION)'

          echo "=== Step 2: RCall in standalone Julia ==="
          julia -e '
            ENV["R_HOME"] = ENV["R_HOME"]
            using RCall
            println("RCall loaded OK")
          ' || echo "RCall standalone failed (expected if R_HOME not set for standalone julia)"

          echo "=== Step 3: JuliaCall::julia_setup() ==="
          Rscript -e '
            message("R_HOME = ", Sys.getenv("R_HOME"))
            message("LD_LIBRARY_PATH = ", Sys.getenv("LD_LIBRARY_PATH"))
            tryCatch({
              JuliaCall::julia_setup(verbose = TRUE)
              message("JuliaCall setup OK")
            }, error = function(e) {
              message("JuliaCall setup failed: ", conditionMessage(e))
              stop(e)
            })
          '
        shell: bash

      - name: Setup PDMPSamplers Julia environment
        if: matrix.config.julia
        run: |
          Rscript -e '
            library(PDMPSamplersR)
            message("=== Calling pdmpsamplers_setup() ===")
            tryCatch(
              pdmpsamplers_setup(verbose = TRUE),
              error = function(e) {
                message("Setup failed: ", conditionMessage(e))
                traceback()
                stop(e)
              }
            )
            message("=== pdmpsamplers_setup() succeeded ===")
          '
        shell: bash

      - name: Debug vignette rendering
        if: matrix.config.julia && runner.os == 'Linux'
        run: |
          echo "=== quarto version ==="
          quarto --version
          echo "=== R package versions ==="
          Rscript -e 'message("ggplot2: ", packageVersion("ggplot2")); message("knitr: ", packageVersion("knitr")); message("quarto: ", packageVersion("quarto"))'
          echo "=== quarto render with trace ==="
          cd vignettes && quarto render stan-examples.qmd --log-level trace 2>&1 || true
        shell: bash
        continue-on-error: true

      - uses: r-lib/actions/check-r-package@v2
        with:
          upload-snapshots: true
          build_args: 'c("--no-manual", "--compact-vignettes=gs+qpdf")'
